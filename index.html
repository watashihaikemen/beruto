<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>æˆ¦ç¥ã®ãƒ™ãƒ«ãƒˆç®¡ç†ãƒ„ãƒ¼ãƒ« (ver1.4)</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 700px; margin: auto; background-color: #f0f2f5; }
    h1 { text-align: center; color: #333; }
    .effect-block { margin-bottom: 20px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background-color: #f9f9f9; }
    label { font-weight: bold; display: block; margin-bottom: 5px; color: #555; }
    .effect-search {
        width: 100%;
        padding: 6px;
        margin-bottom: 8px; /* selectã¨ã®é–“ã«å°‘ã—ä½™ç™½ */
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
    }
    select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 14px; }
    #totalScore { display: none; } /* åˆè¨ˆç‚¹æ•°ã‚’éè¡¨ç¤ºã« */
    .button-group { text-align: center; margin-top: 20px; display: flex; justify-content: center; gap: 10px; }
    .button-group button { padding: 10px 20px; font-size: 16px; cursor: pointer; border: none; border-radius: 5px; color: white; }
    #saveButton { background-color: #28a745; }
    #saveButton:hover { background-color: #218838; }
    #sealSettingsButton { background-color: #6c757d; }
    #sealSettingsButton:hover { background-color: #5a6268; }

    #savedBeltsSection { margin-top: 40px; border-top: 2px solid #eee; padding-top: 20px; }
    #savedBeltsSection h2 { text-align: center; color: #333; }
    #savedBeltsCount { font-size: 16px; color: #666; font-weight: normal; margin-left: 8px; }
    .saved-belt-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; margin-bottom: 12px; background-color: #fff; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: all 0.2s ease-in-out; }
    .saved-belt-item:hover { background-color: #fcfcfc; transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .saved-belt-info { cursor: pointer; flex-grow: 1; }
    .saved-belt-info strong { display: none; }
    .saved-belt-info span { display: block; font-size: 14px; color: #666; margin-top: 4px; }
    .belt-memo { font-size: 13px !important; color: #007bff !important; font-style: italic; margin-top: 8px !important; }
    .saved-belt-actions { display: flex; flex-direction: column; flex-shrink: 0; margin-left: 10px; gap: 5px; }
    .saved-belt-actions-upper { display: flex; gap: 5px; }
    .saved-belt-actions button { color: white; border: none; padding: 5px 8px; font-size: 12px; border-radius: 3px; cursor: pointer; }
    .saved-belt-memo-edit { background-color: #ffc107; color: #212529; width: 100%; }
    .saved-belt-memo-edit:hover { background-color: #e0a800; }
    .saved-belt-lock { background-color: #17a2b8; }
    .saved-belt-lock:hover { background-color: #138496; }
    .saved-belt-delete { background-color: #dc3545; }
    .saved-belt-delete:hover { background-color: #c82333; }
    .saved-belt-delete:disabled { background-color: #6c757d; cursor: not-allowed; opacity: 0.65; }

    .action-button-group { text-align: center; margin-bottom: 15px; display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; }
    .action-button-group button { padding: 8px 15px; font-size: 14px; cursor: pointer; border: 1px solid #ccc; border-radius: 5px; background-color: #f0f0f0; margin: 0; }
    .action-button-group button.active { background-color: #007bff; color: white; border-color: #007bff; }

    /* ã‚«ãƒ†ã‚´ãƒªãƒ¼ã”ã¨ã®è‰²ã‚’å®šç¾© */
    .category-general { background-color: #e0f7fa; border-left: 5px solid #00acc1; }
    .category-pending { background-color: #fffde7; border-left: 5px solid #ffc107; }
    .category-storage { background-color: #eceff1; border-left: 5px solid #607d8b; }
    .category-default { background-color: #ffffff; border-left: 5px solid #dddddd; }
    .category-weapon-0 { background-color: #FBE9E7; border-left: 5px solid #FF5722; }
    .category-weapon-1 { background-color: #FCE4EC; border-left: 5px solid #E91E63; }
    .category-weapon-2 { background-color: #F3E5F5; border-left: 5px solid #9C27B0; }
    /* ... ä»–ã®æ­¦å™¨ã‚«ãƒ†ã‚´ãƒªãƒ¼è‰²ã¯çœç•¥ ... */
    
    /* å°å°è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; }
    .modal-content { background-color: white; padding: 25px; border-radius: 8px; width: 90%; max-width: 650px; max-height: 85vh; overflow-y: auto; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    .modal-content h2 { margin-top: 0; display: flex; align-items: center; justify-content: space-between; }
    #sealedCount { font-size: 1rem; color: #555; font-weight: normal; margin-left: 10px; }
    #sealActionButtons { justify-content: flex-start; margin-bottom: 15px; }
    .modal-actions { text-align: right; margin-top: 20px; }
    .modal-actions button { margin-left: 10px; padding: 8px 15px; cursor: pointer; border-radius: 5px; border: 1px solid #ccc; }
    #saveSealSettingsButton { background-color: #007bff; color: white; border-color: #007bff;}
    #sealGroupsContainer { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px; margin-top: 15px; }
    .seal-group label { display: flex; align-items: center; font-size: 14px; font-weight: normal; padding: 5px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s; }
    .seal-group label:hover { background-color: #f0f0f0; }
    .seal-group input { margin-right: 8px; }

    /* ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; display: flex; flex-direction: column; align-items: center; gap: 10px; }
    .toast { background-color: rgba(0, 0, 0, 0.75); color: white; padding: 12px 20px; border-radius: 25px; font-size: 14px; opacity: 0; transform: translateY(20px); transition: opacity 0.3s ease, transform 0.3s ease; }
    .toast.show { opacity: 1; transform: translateY(0); }
  </style>
</head>
<body>
  <h1>æˆ¦ç¥ã®ãƒ™ãƒ«ãƒˆç®¡ç†ãƒ„ãƒ¼ãƒ«</h1>

  <div id="effectsContainer"></div>
  <div id="totalScore">åˆè¨ˆç‚¹æ•°: 0.0</div>

  <div class="button-group">
    <button id="sealSettingsButton">å°å°åŠ¹æœã®ç®¡ç†</button>
    <button id="saveButton">ç¾åœ¨ã®ãƒ™ãƒ«ãƒˆã‚’ä¿å­˜</button>
  </div>

  <div id="savedBeltsSection">
    <h2>ä¿å­˜ã•ã‚ŒãŸãƒ™ãƒ«ãƒˆ<span id="savedBeltsCount"></span></h2>
    <div id="filterButtonGroup" class="action-button-group"></div>
    <div class="action-button-group" id="sortButtonGroup">
      <button id="sortDivine">ç¥ãƒ™ãƒ«ãƒˆé †</button>
      <button id="sortTrash">ã‚´ãƒŸãƒ™ãƒ«ãƒˆé †</button>
    </div>
    <div id="savedBeltsList"></div>
  </div>

  <div id="sealModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <h2><span>å°å°åŠ¹æœã®ç®¡ç†</span><span id="sealedCount"></span></h2>
        <p>å°å°ã—ãŸã„åŠ¹æœã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚ãƒã‚§ãƒƒã‚¯ã—ãŸåŠ¹æœã¯ã€åŠ¹æœé¸æŠã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã«è¡¨ç¤ºã•ã‚Œãªããªã‚Šã¾ã™ã€‚é¸æŠå¾Œã€ä¿å­˜ã™ã‚‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
        <div id="sealActionButtons" class="action-button-group"></div>
        <div id="sealGroupsContainer"></div>
        <div class="modal-actions">
            <button id="cancelSealSettingsButton">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button id="saveSealSettingsButton">ä¿å­˜ã™ã‚‹</button>
        </div>
    </div>
  </div>

  <div id="toast-container"></div>

  <script>
    const DATA_VERSION = '1.4'; // ãƒ¡ãƒ¢æ©Ÿèƒ½è¿½åŠ ã®ãŸã‚ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—
    const SAVED_BELTS_KEY = 'savedBelts';
    const DATA_VERSION_KEY = 'savedBeltsVersion';
    const SEALED_EFFECTS_KEY = 'sealedEffects';

    // (å®šæ•°å®šç¾©ã¯å¤‰æ›´ãªã—ã®ãŸã‚çœç•¥)
    const WEAPON_EFFECTS = { "ç‰‡æ‰‹å‰£": 18, "ä¸¡æ‰‹å‰£": 17.9, "çŸ­å‰£": 17.8, "ã‚¹ãƒ†ã‚£ãƒƒã‚¯": 17.7, "ä¸¡æ‰‹æ–": 17.6, "ãƒ¤ãƒª": 17.5, "ã‚ªãƒ": 17.4, "æ£": 17.3, "ãƒ„ãƒ¡": 17.2, "ãƒ ãƒ": 17.1, "æ‰‡": 17.0, "ãƒãƒ³ãƒãƒ¼": 16.9, "ãƒ–ãƒ¼ãƒ¡ãƒ©ãƒ³": 16.8, "å¼“": 16.7, "éŒ": 16.6 };
    const WEAPON_NAMES = Object.keys(WEAPON_EFFECTS);
    const ELEMENTS = ["ç‚", "æ°·", "é¢¨", "é›·", "åœŸ", "é—‡", "å…‰"];
    const MONSTER_TYPES = { "ãƒ‰ãƒ©ã‚´ãƒ³ç³»": 16.5, "è™«ç³»": 16.4, "ç£ç³»": 16.3, "ã‚¾ãƒ³ãƒ“ç³»": 16.2, "æ¤ç‰©ç³»": 16.1, "æ€ªäººç³»": 16.0, "æ‚ªé­”ç³»": 15.9, "ã‚¨ãƒ¬ç³»": 15.8, "é³¥ç³»": 15.7, "ç‰©è³ªç³»": 15.6, "ã‚¹ãƒ©ã‚¤ãƒ ç³»": 15.5, "ãƒã‚·ãƒ³ç³»": 15.4, "æ°´ç³»": 15.3 };
    function createAllEffectsData() { /* ... */ }
    const ALL_EFFECTS_DATA = createAllEffectsData();
    let sealableGroups = [];
    let fullOptionsFragment, categoryOptionsFragment, effectOptionsFragment;
    function createFilters() { /* ... */ }
    const FILTERS = createFilters();
    let currentFilter = 'all';
    let currentSortDirection = 'divine';

    // === DOMè¦ç´ ã®å–å¾— ===
    const container = document.getElementById('effectsContainer');
    const savedBeltsList = document.getElementById('savedBeltsList');
    const saveButton = document.getElementById('saveButton');
    const sortDivineButton = document.getElementById('sortDivine');
    const sortTrashButton = document.getElementById('sortTrash');
    const savedBeltsCountElement = document.getElementById('savedBeltsCount');
    const filterButtonGroup = document.getElementById('filterButtonGroup');
    const sortButtonGroup = document.getElementById('sortButtonGroup');
    const sealSettingsButton = document.getElementById('sealSettingsButton');
    const sealModal = document.getElementById('sealModal');
    const sealActionButtonsContainer = document.getElementById('sealActionButtons');
    const sealGroupsContainer = document.getElementById('sealGroupsContainer');
    const saveSealSettingsButton = document.getElementById('saveSealSettingsButton');
    const cancelSealSettingsButton = document.getElementById('cancelSealSettingsButton');
    const sealedCountElement = document.getElementById('sealedCount');
    const toastContainer = document.getElementById('toast-container');
    
    // === ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥æ©Ÿèƒ½ ===
    function showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;
        toastContainer.appendChild(toast);

        setTimeout(() => {
            toast.classList.add('show');
        }, 10); // å°‘ã—é…ã‚‰ã›ã¦CSS transitionã‚’ç™ºç«ã•ã›ã‚‹

        setTimeout(() => {
            toast.classList.remove('show');
            toast.addEventListener('transitionend', () => toast.remove());
        }, 3000);
    }
    
    // === å°å°æ©Ÿèƒ½é–¢é€£ ===
    function generateSealableGroups() { /* ... */ }
    function getSealedGroups() { /* ... */ }
    function isEffectSealed(effect, sealedGroups) { /* ... */ }
    function updateSealedCount() { /* ... */ }

    function populateSealModal() {
        // ã€Œã™ã¹ã¦é¸æŠã€ã€Œã™ã¹ã¦è§£é™¤ã€ãƒœã‚¿ãƒ³ã®ç”Ÿæˆ
        sealActionButtonsContainer.innerHTML = '';
        const selectAllButton = document.createElement('button');
        selectAllButton.textContent = 'ã™ã¹ã¦é¸æŠ';
        selectAllButton.addEventListener('click', () => {
            sealGroupsContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
            updateSealedCount();
        });

        const deselectAllButton = document.createElement('button');
        deselectAllButton.textContent = 'ã™ã¹ã¦è§£é™¤';
        deselectAllButton.addEventListener('click', () => {
            sealGroupsContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            updateSealedCount();
        });
        
        sealActionButtonsContainer.appendChild(selectAllButton);
        sealActionButtonsContainer.appendChild(deselectAllButton);

        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãƒªã‚¹ãƒˆã®ç”Ÿæˆ
        sealGroupsContainer.innerHTML = '';
        const sealedGroups = getSealedGroups();
        
        sealableGroups.forEach(group => {
            const div = document.createElement('div');
            div.className = 'seal-group';
            const label = document.createElement('label');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = group;
            checkbox.checked = sealedGroups.includes(group);
            checkbox.addEventListener('change', updateSealedCount);
            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(group));
            div.appendChild(label);
            sealGroupsContainer.appendChild(div);
        });

        updateSealedCount();
    }

    function saveSealSettings() {
        const checkboxes = sealGroupsContainer.querySelectorAll('input[type="checkbox"]:checked');
        const sealedGroups = Array.from(checkboxes).map(cb => cb.value);
        localStorage.setItem(SEALED_EFFECTS_KEY, JSON.stringify(sealedGroups));
        sealModal.style.display = 'none';
        updateAllSelectOptions();
        showToast("å°å°è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
    }

    // === ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒªã‚¹ãƒˆã®ç®¡ç† ===
    function rebuildOptionFragments() { /* ... */ }
    function updateAllSelectOptions() { /* ... */ }

    // === ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ ===
    function migrateSavedBelts() {
        console.log("Checking for data migration...");
        let savedBelts = getSavedBelts(true);
        if (savedBelts.length === 0) {
            localStorage.setItem(DATA_VERSION_KEY, DATA_VERSION);
            console.log("No belts to migrate. Set current data version.");
            return;
        }

        let needsSave = false;
        // v1.3ä»¥å‰ã®é…åˆ—å½¢å¼ or v1.4ä»¥å‰ã®ãƒ¡ãƒ¢ãªã—ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå½¢å¼ã‹ã‚‰ã®ç§»è¡Œ
        if (Array.isArray(savedBelts[0]) || savedBelts[0].memo === undefined) {
            console.log("Old data format detected. Migrating to new format with memo field.");
            savedBelts = savedBelts.map(belt => {
                if(Array.isArray(belt)) { // v1.3å½¢å¼
                    const effects = belt.slice(1);
                    effects.sort((a,b)=>(ALL_EFFECTS_DATA[b]||0)-(ALL_EFFECTS_DATA[a]||0));
                    return { effects: [belt[0] || "åŠ¹æœãªã—", ...effects], locked: false, memo: "" };
                } else { // ãƒ¡ãƒ¢ãŒãªã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå½¢å¼
                    return { ...belt, memo: belt.memo || "" };
                }
            });
            needsSave = true;
            console.log(`Data migration complete. ${savedBelts.length} belts have been migrated.`);
        } else {
            console.log("Data is already up to date.");
        }
        
        if (needsSave) {
            localStorage.setItem(SAVED_BELTS_KEY, JSON.stringify(savedBelts));
        }
        localStorage.setItem(DATA_VERSION_KEY, DATA_VERSION);
    }
    
    function saveCurrentBelt() {
        const selects = container.querySelectorAll('select');
        const effects = Array.from(selects).map(select => select.value);
        if (effects.every(v=>v==="åŠ¹æœãªã—")) return;
        
        const memo = prompt("ã“ã®ãƒ™ãƒ«ãƒˆã®ãƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šæ±ç”¨ç‰©ç†ç”¨ï¼‰", "");
        if (memo === null) { // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸå ´åˆã¯ä¿å­˜ã—ãªã„
            return;
        }

        const newBelt = { effects: effects, locked: false, memo: memo };
        const savedBelts = getSavedBelts();
        savedBelts.push(newBelt);
        localStorage.setItem(SAVED_BELTS_KEY, JSON.stringify(savedBelts));
        updateDisplay();
        showToast("ç¾åœ¨ã®ãƒ™ãƒ«ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
    }
    
    function deleteBelt(effectsToDelete) {
        let savedBelts = getSavedBelts();
        const effectsToDeleteStr = JSON.stringify(effectsToDelete);
        const updatedBelts = savedBelts.filter(belt => JSON.stringify(belt.effects) !== effectsToDeleteStr);
        if (savedBelts.length !== updatedBelts.length) {
            localStorage.setItem(SAVED_BELTS_KEY, JSON.stringify(updatedBelts));
            updateDisplay();
            showToast("ãƒ™ãƒ«ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚");
        }
    }

    function editMemo(effectsToEdit) {
        let savedBelts = getSavedBelts();
        const effectsToEditStr = JSON.stringify(effectsToEdit);
        const beltToEdit = savedBelts.find(belt => JSON.stringify(belt.effects) === effectsToEditStr);
        
        if (beltToEdit) {
            const newMemo = prompt("ãƒ™ãƒ«ãƒˆã®ãƒ¡ãƒ¢ã‚’ç·¨é›†ã—ã¦ãã ã•ã„", beltToEdit.memo);
            if (newMemo !== null) { // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œãªã‹ã£ãŸå ´åˆ
                beltToEdit.memo = newMemo;
                localStorage.setItem(SAVED_BELTS_KEY, JSON.stringify(savedBelts));
                updateDisplay();
                showToast("ãƒ¡ãƒ¢ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚");
            }
        }
    }

    function renderSavedBelts(beltsToRender) {
        savedBeltsList.innerHTML = '';
        const totalSavedCount = getSavedBelts().length;
        savedBeltsCountElement.textContent = `(è¡¨ç¤º: ${beltsToRender.length}å€‹ / åˆè¨ˆ: ${totalSavedCount}å€‹)`;
        const categoryClassMap={/* ... */};
        WEAPON_NAMES.forEach((n,i)=>{categoryClassMap[`${n}ç”¨ãƒ™ãƒ«ãƒˆ (ã‚«ãƒ†ã‚´ãƒªãƒ¼ç”¨)`]=`category-weapon-${i}`});

        beltsToRender.forEach((beltData) => {
            const { effects, score, locked, memo } = beltData;
            const categoryEffect = effects[0] || 'åŠ¹æœãªã—';
            const beltItem = document.createElement('div');
            beltItem.className = 'saved-belt-item';
            const categoryClassName = categoryClassMap[categoryEffect] || 'category-default';
            beltItem.classList.add(categoryClassName);

            const beltInfo = document.createElement('div');
            beltInfo.className = 'saved-belt-info';
            beltInfo.addEventListener('click', () => loadBelt(effects));
            const validEffects = effects.filter(e => e !== 'åŠ¹æœãªã—');
            validEffects.forEach(effect => {
                const effectSpan = document.createElement('span');
                effectSpan.textContent = effect;
                beltInfo.appendChild(effectSpan);
            });
            
            if (memo) {
                const memoSpan = document.createElement('span');
                memoSpan.className = 'belt-memo';
                memoSpan.textContent = `ğŸ“ ${memo}`;
                beltInfo.appendChild(memoSpan);
            }

            const actionButtons = document.createElement('div');
            actionButtons.className = 'saved-belt-actions';
            
            const upperActions = document.createElement('div');
            upperActions.className = 'saved-belt-actions-upper';

            const lockButton = document.createElement('button');
            lockButton.className = 'saved-belt-lock';
            lockButton.textContent = locked ? 'è§£é™¤' : 'ãƒ­ãƒƒã‚¯';
            lockButton.addEventListener('click', (e) => { e.stopPropagation(); toggleLockState(effects); });
            
            const deleteButton = document.createElement('button');
            deleteButton.className = 'saved-belt-delete';
            deleteButton.textContent = 'å‰Šé™¤';
            deleteButton.disabled = locked;
            deleteButton.addEventListener('click', (e) => { e.stopPropagation(); deleteBelt(effects); });
            
            upperActions.appendChild(lockButton);
            upperActions.appendChild(deleteButton);
            
            const memoEditButton = document.createElement('button');
            memoEditButton.className = 'saved-belt-memo-edit';
            memoEditButton.textContent = 'ãƒ¡ãƒ¢ç·¨é›†';
            memoEditButton.addEventListener('click', (e) => { e.stopPropagation(); editMemo(effects); });

            actionButtons.appendChild(upperActions);
            actionButtons.appendChild(memoEditButton);

            beltItem.appendChild(beltInfo);
            beltItem.appendChild(actionButtons);
            savedBeltsList.appendChild(beltItem);
        });
    }
    
    // (ä»–ã®JSé–¢æ•°ã¯å¤§ããªå¤‰æ›´ãŒãªã„ãŸã‚ã€ã“ã“ã§ã¯çœç•¥ã—ã¾ã™)
    // --- çœç•¥ã•ã‚ŒãŸé–¢æ•°ç¾¤ï¼ˆå†…å®¹ã¯å¤‰æ›´ãªã—ï¼‰---
    function createAllEffectsData(){const e={"åŠ¹æœãªã—":-30,"ã“ã†ã’ãåŠ›+15":15,"ã“ã†ã’ãåŠ›+20":21.8,"ã“ã†ã’ãåŠ›+25":22,"ã“ã†ã’ãé­”åŠ›ã¨å›å¾©é­”åŠ›+30":14.9,"ã“ã†ã’ãé­”åŠ›ã¨å›å¾©é­”åŠ›+40":21.7,"ã“ã†ã’ãé­”åŠ›ã¨å›å¾©é­”åŠ›+50":21.9,"ä¼šå¿ƒç‡ã¨å‘ªæ–‡æš´èµ°ç‡+1.0%":14.8,"ä¼šå¿ƒç‡ã¨å‘ªæ–‡æš´èµ°ç‡+1.5%":21.7,"ä¼šå¿ƒç‡ã¨å‘ªæ–‡æš´èµ°ç‡+2.0%":21.8,"ç›¾è£…å‚™ã§é–‹æˆ¦æ™‚â—‹â—‹ç³»":.05},t={"æ±ç”¨ãƒ™ãƒ«ãƒˆ (ã‚«ãƒ†ã‚´ãƒªãƒ¼ç”¨)":4e4,"ä¿ç•™ä¸­ã®ãƒ™ãƒ«ãƒˆ (ã‚«ãƒ†ã‚´ãƒªãƒ¼ç”¨)":6e3,"å–ã‚Šæ•¢ãˆãšåç´ (ã‚«ãƒ†ã‚´ãƒªãƒ¼ç”¨)":4e3};let a=38e3;return WEAPON_NAMES.forEach(n=>{t[`${n}ç”¨ãƒ™ãƒ«ãƒˆ (ã‚«ãƒ†ã‚´ãƒªãƒ¼ç”¨)`]=a,a-=2e3}),Object.keys(WEAPON_EFFECTS).forEach(t=>{const a=WEAPON_EFFECTS[t];ELEMENTS.forEach(n=>{[12,13,14,15].forEach(o=>{e[`${t}è£…å‚™æ™‚ ${n}ã®æ”»æ’ƒãƒ€ãƒ¡ãƒ¼ã‚¸+${o}%`]=a+o-12})})}),Object.keys(MONSTER_TYPES).forEach(t=>{const a=MONSTER_TYPES[t];for(let n=0;n<4;n++)e[`${t}ã«ãƒ€ãƒ¡ãƒ¼ã‚¸+${9+n}%`]=a+n}),{...t,...e}}
    function createFilters(){const e={all:{min:-1/0,max:1/0},general:{min:39849,max:40499},pending:{min:5849,max:7848},storage:{min:3849,max:5848}};let t=38e3;return WEAPON_NAMES.forEach(a=>{const n=t-2e3;e[a]={min:n+1849,max:t+1848},t-=2e3}),e}
    function getSealedGroups(){const e=localStorage.getItem(SEALED_EFFECTS_KEY);return e?JSON.parse(e):[]}
    function isEffectSealed(e,t){return!(!t||0===t.length)&&t.some(t=>e.startsWith(t.replace(/\+\?%?/,"").replace("â—‹â—‹ç³»","")))}
    function updateSealedCount(){if(sealableGroups&&0!==sealableGroups.length){const e=sealGroupsContainer.querySelectorAll('input[type="checkbox"]:checked').length,t=sealableGroups.length;sealedCountElement.textContent=`(${e} / ${t} ä»¶ å°å°ä¸­)`}}
    function rebuildOptionFragments(){fullOptionsFragment=document.createDocumentFragment(),categoryOptionsFragment=document.createDocumentFragment(),effectOptionsFragment=document.createDocumentFragment();const e=getSealedGroups();for(let t in ALL_EFFECTS_DATA){if(isEffectSealed(t,e))continue;const a=document.createElement("option");a.value=t,a.textContent=t,fullOptionsFragment.appendChild(a.cloneNode(!0)),(t.includes("(ã‚«ãƒ†ã‚´ãƒªãƒ¼ç”¨)")||"åŠ¹æœãªã—"===t)&&categoryOptionsFragment.appendChild(a.cloneNode(!0)),t.includes("(ã‚«ãƒ†ã‚´ãƒªãƒ¼ç”¨)")&&"åŠ¹æœãªã—"!==t||effectOptionsFragment.appendChild(a.cloneNode(!0))}}
    function updateAllSelectOptions(){rebuildOptionFragments();const e=document.querySelectorAll("#effectsContainer select");e.forEach(e=>{const t=e.value,a=e.previousElementSibling;e.innerHTML="","category"===e.dataset.type?e.appendChild(categoryOptionsFragment.cloneNode(!0)):e.appendChild(effectOptionsFragment.cloneNode(!0)),Array.from(e.options).some(e=>e.value===t)?e.value=t:e.value="åŠ¹æœãªã—",""!==a.value&&filterOptions(a,e)}),updateAndSort()}
    function filterOptions(e,t){const a=e.value.toLowerCase(),n=t.value,o="category"===t.dataset.type?categoryOptionsFragment:effectOptionsFragment;if(""===a)t.innerHTML="",t.appendChild(o.cloneNode(!0));else{const e=Array.from(fullOptionsFragment.children).filter(e=>e.textContent.toLowerCase().includes(a));t.innerHTML="",e.forEach(e=>t.appendChild(e.cloneNode(!0)))}if(Array.from(t.options).every(e=>e.value!==n)){const e=document.createElement("option");e.value=n,e.textContent=n,t.insertBefore(e,t.firstChild)}t.value=n}
    function createEffectSelects(){const e=["ã‚«ãƒ†ã‚´ãƒªãƒ¼","åŠ¹æœ 1","åŠ¹æœ 2","åŠ¹æœ 3","åŠ¹æœ 4","åŠ¹æœ 5"];for(let t=0;t<6;t++){const a=document.createElement("div");a.className="effect-block";const n=document.createElement("label");n.textContent=e[t];const o=document.createElement("input");o.type="text",o.className="effect-search",o.placeholder="åŠ¹æœã‚’æ¤œç´¢ã—ã¦çµã‚Šè¾¼ã¿...";const l=document.createElement("select");l.dataset.type=0===t?"category":"effect",l.addEventListener("change",()=>{""!==o.value&&(o.value="",filterOptions(o,l)),updateAndSort()}),o.addEventListener("input",()=>filterOptions(o,l)),a.appendChild(n),a.appendChild(o),a.appendChild(l),container.appendChild(a)}updateAllSelectOptions()}
    function createFilterButtons(){filterButtonGroup.innerHTML="";const e=[{filter:"all",text:"ã™ã¹ã¦è¡¨ç¤º"},{filter:"general",text:"æ±ç”¨ãƒ™ãƒ«ãƒˆ"},...WEAPON_NAMES.map(e=>({filter:e,text:`${e}ç”¨`})),{filter:"pending",text:"ä¿ç•™ä¸­ã®ãƒ™ãƒ«ãƒˆ"},{filter:"storage",text:"å–ã‚Šæ•¢ãˆãšåç´"}];e.forEach(({filter:e,text:t})=>{const a=document.createElement("button");a.dataset.filter=e,a.textContent=t,a.addEventListener("click",()=>{currentFilter=a.dataset.filter,updateDisplay()}),filterButtonGroup.appendChild(a)})}
    function updateAndSort(){const e=Array.from(container.querySelectorAll('select[data-type="effect"]')),t=e.map(e=>e.value);t.sort((e,t)=>(ALL_EFFECTS_DATA[t]||0)-(ALL_EFFECTS_DATA[e]||0)),e.forEach((e,a)=>{const n=t[a];e.value!==n&&(e.value=n)});let a=0;const n=container.querySelectorAll("select");n.forEach(e=>{a+=ALL_EFFECTS_DATA[e.value]||0}),document.getElementById("totalScore").textContent=`åˆè¨ˆç‚¹æ•°: ${a.toFixed(1)}`}
    function getSavedBelts(e=!1){const t=localStorage.getItem(SAVED_BELTS_KEY);return e?t?JSON.parse(t):[]:t?JSON.parse(t):[]}
    function calculateTotalScore(e){return e.reduce((e,t)=>e+(ALL_EFFECTS_DATA[t]||0),0)}
    function updateDisplay(){let e=getSavedBelts();let t=e.map(e=>({...e,score:calculateTotalScore(e.effects)}));const a=FILTERS[currentFilter],n=t.filter(e=>a&&e.score>=a.min&&e.score<=a.max);n.sort((e,t)=>"divine"===currentSortDirection?t.score-e.score:e.score-t.score),renderSavedBelts(n),updateActiveButtons()}
    function toggleLockState(e){let t=getSavedBelts();const a=JSON.stringify(e),n=t.find(e=>JSON.stringify(e.effects)===a);n&&(n.locked=!n.locked,localStorage.setItem(SAVED_BELTS_KEY,JSON.stringify(t)),updateDisplay(),showToast(n.locked?"ãƒ™ãƒ«ãƒˆã‚’ãƒ­ãƒƒã‚¯ã—ã¾ã—ãŸã€‚":"ãƒ™ãƒ«ãƒˆã®ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã—ã¾ã—ãŸã€‚"))}
    function updateActiveButtons(){filterButtonGroup.querySelectorAll("button").forEach(e=>{e.classList.toggle("active",e.dataset.filter===currentFilter)}),sortButtonGroup.querySelectorAll("button").forEach(e=>{const t=e.id;e.classList.toggle("active","sortDivine"===t&&"divine"===currentSortDirection||"sortTrash"===t&&"trash"===currentSortDirection)})}
    function loadBelt(e){const t=container.querySelectorAll("select"),a=container.querySelectorAll(".effect-search");a.forEach((a,n)=>{""!==a.value&&(a.value="",filterOptions(a,t[n]))}),t.forEach((t,a)=>{t.value=e[a]||"åŠ¹æœãªã—"}),updateAndSort(),window.scrollTo(0,0)}
    function generateSealableGroups(){const e=[];e.push({group:"ã“ã†ã’ãåŠ›+?",score:ALL_EFFECTS_DATA["ã“ã†ã’ãåŠ›+25"]}),e.push({group:"ã“ã†ã’ãé­”åŠ›ã¨å›å¾©é­”åŠ›+?",score:ALL_EFFECTS_DATA["ã“ã†ã’ãé­”åŠ›ã¨å›å¾©é­”åŠ›+50"]}),e.push({group:"ä¼šå¿ƒç‡ã¨å‘ªæ–‡æš´èµ°ç‡+?%",score:ALL_EFFECTS_DATA["ä¼šå¿ƒç‡ã¨å‘ªæ–‡æš´èµ°ç‡+2.0%"]}),WEAPON_NAMES.forEach(t=>{const a=WEAPON_EFFECTS[t];ELEMENTS.forEach(n=>{e.push({group:`${t}è£…å‚™æ™‚ ${n}ã®æ”»æ’ƒãƒ€ãƒ¡ãƒ¼ã‚¸+?%`,score:a+3})})}),Object.keys(MONSTER_TYPES).forEach(t=>{const a=MONSTER_TYPES[t];e.push({group:`${t}ã«ãƒ€ãƒ¡ãƒ¼ã‚¸+?%`,score:a+3})}),e.push({group:"ç›¾è£…å‚™ã§é–‹æˆ¦æ™‚â—‹â—‹ç³»",score:ALL_EFFECTS_DATA["ç›¾è£…å‚™ã§é–‹æˆ¦æ™‚â—‹â—‹ç³»"]}),e.sort((e,t)=>{if(t.score!==e.score)return t.score-e.score;e.group.localeCompare(t.group,"ja")}),sealableGroups=e.map(e=>e.group)}
    // --- çœç•¥ã“ã“ã¾ã§ ---

    // === åˆæœŸåŒ–å‡¦ç† ===
    document.addEventListener('DOMContentLoaded', () => {
        const storedVersion = localStorage.getItem(DATA_VERSION_KEY);
        if (storedVersion !== DATA_VERSION) {
            migrateSavedBelts();
        }

        generateSealableGroups();
        createEffectSelects();
        createFilterButtons();
        updateAndSort();
        
        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š ---
        saveButton.addEventListener('click', saveCurrentBelt);
        sortDivineButton.addEventListener('click', () => { currentSortDirection = 'divine'; updateDisplay(); });
        sortTrashButton.addEventListener('click', () => { currentSortDirection = 'trash'; updateDisplay(); });
        
        sealSettingsButton.addEventListener('click', () => {
            populateSealModal();
            sealModal.style.display = 'flex';
        });
        cancelSealSettingsButton.addEventListener('click', () => sealModal.style.display = 'none');
        saveSealSettingsButton.addEventListener('click', saveSealSettings);
        sealModal.addEventListener('click', (e) => {
            if (e.target === sealModal) sealModal.style.display = 'none';
        });

        updateDisplay();
    });
  </script>
</body>
</html>


